<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Practice Questions | StudyDecoder Junior</title>
    <link rel="icon" type="image/png" href="logo.png">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html, body {
            height: 100%; width: 100%;
            font-family: 'Segoe UI', -apple-system, BlinkMacSystemFont, sans-serif;
            background: #0f1419; color: #e7e9ea;
        }
        .app-container { display: flex; flex-direction: column; height: 100vh; width: 100vw; }
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-bottom: 1px solid #2f3336;
            padding: 12px 24px; display: flex; align-items: center;
            justify-content: space-between; flex-shrink: 0;
        }
        .header-left { display: flex; align-items: center; gap: 16px; }
        .back-btn {
            color: #fff; text-decoration: none; font-size: 14px; font-weight: 500;
            padding: 8px 16px; border-radius: 8px; background: rgba(255,255,255,0.15);
            transition: all 0.2s;
        }
        .back-btn:hover { background: rgba(255,255,255,0.25); }
        .header-title { font-size: 20px; font-weight: 700; color: #fff; }
        .header-subtitle { font-size: 12px; color: rgba(255,255,255,0.8); margin-top: 2px; }
        .main-content { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
        .output-panel { flex: 1; overflow-y: auto; padding: 24px; background: #0f1419; }
        .output-content { max-width: 900px; margin: 0 auto; }
        .welcome-message { text-align: center; padding: 60px 20px; color: #71767b; }
        .welcome-message h2 { font-size: 28px; color: #e7e9ea; margin-bottom: 12px; font-weight: 700; }
        .welcome-message p { font-size: 16px; line-height: 1.6; max-width: 500px; margin: 0 auto; }
        .message { margin-bottom: 24px; animation: fadeIn 0.3s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .message-user {
            background: #4a3f8a; border-radius: 16px 16px 4px 16px;
            padding: 16px 20px; margin-left: auto; max-width: 80%; width: fit-content;
        }
        .message-assistant {
            background: #16202a; border: 1px solid #2f3336;
            border-radius: 4px 16px 16px 16px; padding: 20px 24px;
        }
        .message-assistant h2 { color: #667eea; font-size: 16px; font-weight: 600; margin: 16px 0 8px 0; }
        .message-assistant h2:first-child { margin-top: 0; }
        .message-assistant p { margin-bottom: 12px; line-height: 1.7; }
        .message-assistant ul, .message-assistant ol { margin: 8px 0; padding-left: 20px; }
        .message-assistant li { margin-bottom: 6px; line-height: 1.6; }
        .message-assistant strong { color: #667eea; }
        .loading { display: flex; align-items: center; gap: 8px; color: #71767b; padding: 16px; }
        .loading-dots { display: flex; gap: 4px; }
        .loading-dots span {
            width: 8px; height: 8px; background: #667eea; border-radius: 50%;
            animation: bounce 1.4s infinite ease-in-out both;
        }
        .loading-dots span:nth-child(1) { animation-delay: -0.32s; }
        .loading-dots span:nth-child(2) { animation-delay: -0.16s; }
        @keyframes bounce { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1); } }
        .input-panel {
            background: #16202a; border-top: 1px solid #2f3336;
            padding: 20px 24px; flex-shrink: 0;
        }
        .input-form { max-width: 900px; margin: 0 auto; }
        .form-title { font-size: 16px; font-weight: 600; color: #e7e9ea; margin-bottom: 16px; text-align: center; }
        .form-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-bottom: 12px; }
        .form-group { display: flex; flex-direction: column; gap: 6px; }
        .form-group.full-width { grid-column: 1 / -1; }
        .form-label { font-size: 12px; font-weight: 500; color: #71767b; }
        .form-input, .form-select {
            background: #0f1419; border: 1px solid #2f3336; border-radius: 8px;
            padding: 12px 14px; color: #e7e9ea; font-size: 14px; font-family: inherit;
            transition: border-color 0.2s;
        }
        .form-input:focus, .form-select:focus { outline: none; border-color: #667eea; }
        .checkbox-group { display: flex; align-items: center; gap: 8px; padding: 8px 0; }
        .checkbox-group input { width: 18px; height: 18px; accent-color: #667eea; }
        .checkbox-group label { font-size: 14px; color: #e7e9ea; }
        .submit-btn {
            width: 100%; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #fff; border: none; border-radius: 8px;
            padding: 14px 24px; font-size: 15px; font-weight: 600; cursor: pointer;
            transition: all 0.2s; margin-top: 8px;
        }
        .submit-btn:hover:not(:disabled) { transform: translateY(-1px); box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4); }
        .submit-btn:disabled { opacity: 0.5; cursor: not-allowed; }
        @media (max-width: 768px) {
            .form-grid { grid-template-columns: 1fr 1fr; }
            .header { padding: 12px 16px; }
            .header-title { font-size: 16px; }
        }
        @media (max-width: 480px) { .form-grid { grid-template-columns: 1fr; } }
        /* Auth overlay styles */
        .auth-loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: #0f1419;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }
        .auth-spinner {
            width: 50px;
            height: 50px;
            border: 4px solid #2f3336;
            border-top-color: #667eea;
            border-radius: 50%;
            animation: authSpin 1s linear infinite;
        }
        @keyframes authSpin { to { transform: rotate(360deg); } }
        .auth-text {
            margin-top: 16px;
            color: #71767b;
            font-size: 1rem;
        }
        .hidden { display: none !important; }
    </style>
</head>
<body>
    <!-- Auth loading overlay -->
    <div class="auth-loading-overlay" id="authOverlay">
        <div class="auth-spinner"></div>
        <div class="auth-text">Checking access...</div>
    </div>

    <div class="app-container hidden" id="mainContent">
        <header class="header">
            <div class="header-left">
                <a href="junior-bot.html" class="back-btn">← Back</a>
                <div>
                    <div class="header-title">Practice Questions</div>
                    <div class="header-subtitle">StudyDecoder Junior • Years 7-10</div>
                </div>
            </div>
        </header>
        <main class="main-content">
            <div class="output-panel" id="outputPanel">
                <div class="output-content" id="outputContent">
                    <div class="welcome-message">
                        <h2>Practice Questions</h2>
                        <p>Generate practice questions matched to your year level and subject. Get ready for tests and exams with curriculum-aligned questions.</p>
                    </div>
                </div>
            </div>
            <div class="input-panel">
                <form class="input-form" id="inputForm">
                    <div class="form-title">Generate Practice Questions</div>
                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label">Subject</label>
                            <select class="form-select" id="subject" required>
                                <option value="">Select subject...</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Year Level</label>
                            <select class="form-select" id="yearLevel" required>
                                <option value="Year 7">Year 7</option>
                                <option value="Year 8">Year 8</option>
                                <option value="Year 9">Year 9</option>
                                <option value="Year 10">Year 10</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Topic</label>
                            <select class="form-select" id="topic" required>
                                <option value="">Select subject first...</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Difficulty</label>
                            <select class="form-select" id="difficulty" required>
                                <option value="Easy">Easy</option>
                                <option value="Medium" selected>Medium</option>
                                <option value="Hard">Hard</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Number of Questions</label>
                            <select class="form-select" id="numQuestions">
                                <option value="3" selected>3</option>
                                <option value="5">5</option>
                                <option value="10">10</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <div class="checkbox-group">
                                <input type="checkbox" id="includeAnswers">
                                <label for="includeAnswers">Include Answers</label>
                            </div>
                        </div>
                    </div>
                    <button type="submit" class="submit-btn" id="submitBtn">Generate Questions</button>
                </form>
            </div>
        </main>
    </div>
    <script>
        const API_BASE = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1' ? 'http://localhost:3001' : '';
        let conversationHistory = [];
        let isLoading = false;
        let subjects = [];
        
        const form = document.getElementById('inputForm');
        const outputContent = document.getElementById('outputContent');
        const outputPanel = document.getElementById('outputPanel');
        const submitBtn = document.getElementById('submitBtn');
        const subjectSelect = document.getElementById('subject');
        
        // Hardcoded Junior subjects (Years 7-10)
        subjects = [
            { id: 'english-7-10', name: 'English (Years 7-10)', category: 'English' },
            { id: 'mathematics-7-10', name: 'Mathematics (Years 7-10)', category: 'Mathematics' },
            { id: 'science-7-10', name: 'Science (Years 7-10)', category: 'Science' }
        ];
        
        // Populate subjects dropdown
        function loadSubjects() {
            subjectSelect.innerHTML = '<option value="">Select subject...</option>';
            subjects.forEach(s => {
                const opt = document.createElement('option');
                opt.value = s.id;
                opt.textContent = s.name;
                subjectSelect.appendChild(opt);
            });
        }
        loadSubjects();
        
        // Topics for junior subjects
        const subjectTopics = {
            'english-7-10': ['Reading and Comprehension', 'Creative Writing', 'Persuasive Writing', 'Essay Writing', 'Poetry Analysis', 'Novel Study', 'Film Study', 'Grammar and Punctuation', 'Speaking and Listening'],
            'mathematics-7-10': ['Integers', 'Fractions and Decimals', 'Ratios and Rates', 'Percentages', 'Algebra - Equations', 'Linear Relationships', 'Measurement - Area and Volume', 'Geometry - Angles and Shapes', 'Statistics and Graphs', 'Probability', 'Trigonometry'],
            'science-7-10': ['Cells and Living Things', 'Body Systems', 'Ecosystems', 'Classification', 'Forces and Motion', 'Energy', 'Waves and Sound', 'Electricity', 'Elements and Compounds', 'Chemical Reactions', 'Atoms and Particles', 'Rocks and Minerals', 'Earth Systems', 'Space and the Universe']
        };
        
        const topicSelect = document.getElementById('topic');
        
        subjectSelect.addEventListener('change', () => {
            const subjectId = subjectSelect.value;
            topicSelect.innerHTML = '';
            
            if (!subjectId) {
                topicSelect.innerHTML = '<option value="">Select subject first...</option>';
                return;
            }
            
            const topics = subjectTopics[subjectId];
            if (topics && topics.length > 0) {
                topicSelect.innerHTML = '<option value="">Select a topic...</option>';
                topics.forEach(t => {
                    const opt = document.createElement('option');
                    opt.value = t;
                    opt.textContent = t;
                    topicSelect.appendChild(opt);
                });
            } else {
                topicSelect.innerHTML = '<option value="All Topics">All Topics</option>';
            }
        });
        
        function formatResponse(text) {
            return text
                .replace(/## (.*)/g, '<h2>$1</h2>')
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/^\- (.*)/gm, '<li>$1</li>')
                .replace(/(<li>.*<\/li>\n?)+/g, '<ul>$&</ul>')
                .replace(/^\d+\. (.*)/gm, '<li>$1</li>')
                .replace(/\n\n/g, '</p><p>')
                .replace(/\n/g, '<br>');
        }
        
        function addMessage(content, isUser = false) {
            const welcome = outputContent.querySelector('.welcome-message');
            if (welcome) welcome.remove();
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${isUser ? 'message-user' : 'message-assistant'}`;
            messageDiv.innerHTML = isUser ? content.replace(/\n/g, '<br>') : `<p>${formatResponse(content)}</p>`;
            outputContent.appendChild(messageDiv);
            outputPanel.scrollTop = outputPanel.scrollHeight;
        }
        
        function showLoading() {
            const loadingDiv = document.createElement('div');
            loadingDiv.className = 'loading';
            loadingDiv.id = 'loadingIndicator';
            loadingDiv.innerHTML = '<div class="loading-dots"><span></span><span></span><span></span></div><span>Generating questions...</span>';
            outputContent.appendChild(loadingDiv);
            outputPanel.scrollTop = outputPanel.scrollHeight;
        }
        
        function hideLoading() {
            const loading = document.getElementById('loadingIndicator');
            if (loading) loading.remove();
        }
        
        async function sendMessage(userMessage, subjectId) {
            if (isLoading) return;
            isLoading = true;
            submitBtn.disabled = true;
            submitBtn.textContent = 'Generating...';
            conversationHistory.push({ role: 'user', content: userMessage });
            addMessage(userMessage, true);
            showLoading();
            
            try {
                const response = await fetch(`${API_BASE}/api/junior-chat/practice`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ messages: conversationHistory, subject: subjectId })
                });
                if (!response.ok) throw new Error('Failed');
                const data = await response.json();
                hideLoading();
                conversationHistory.push({ role: 'assistant', content: data.reply });
                addMessage(data.reply, false);
            } catch (error) {
                hideLoading();
                addMessage('Error: Unable to generate questions. Please try again.', false);
            } finally {
                isLoading = false;
                submitBtn.disabled = false;
                submitBtn.textContent = 'Generate Questions';
            }
        }
        
        form.addEventListener('submit', (e) => {
            e.preventDefault();
            const subjectId = document.getElementById('subject').value;
            if (!subjectId) { alert('Please select a subject.'); return; }
            const subjectName = subjectSelect.options[subjectSelect.selectedIndex].text;
            const yearLevel = document.getElementById('yearLevel').value;
            const topic = topicSelect.options[topicSelect.selectedIndex]?.text || 'All Topics';
            if (!topic || topic === 'Select subject first...' || topic === 'Select a topic...') { alert('Please select a topic.'); return; }
            const difficulty = document.getElementById('difficulty').value;
            const numQuestions = document.getElementById('numQuestions').value;
            const includeAnswers = document.getElementById('includeAnswers').checked;
            
            const message = `Subject: ${subjectName}\nYear Level: ${yearLevel}\nTopic: ${topic}\nDifficulty: ${difficulty}\nNumber of Questions: ${numQuestions}${includeAnswers ? '\n\nPlease include answers with step-by-step explanations.' : ''}`;
            sendMessage(message, subjectId);
        });

        // =====================
        // AUTHENTICATION CHECK
        // =====================
        async function checkAuth() {
            try {
                const res = await fetch(`${API_BASE}/api/subscription`, {
                    credentials: 'include'
                });
                
                if (!res.ok) {
                    window.location.href = '/login.html?redirect=' + encodeURIComponent(window.location.pathname);
                    return;
                }
                
                const data = await res.json();
                
                // Check if has access (owner, lifetime, og_tester, subscribed, or free tier acknowledged)
                const hasAccess = data.role === 'owner' || data.role === 'lifetime' || data.role === 'og_tester' || data.subscribed || data.freeAcknowledged;
                if (!hasAccess) {
                    window.location.href = '/junior-bot.html';
                    return;
                }
                
                document.getElementById('authOverlay').classList.add('hidden');
                document.getElementById('mainContent').classList.remove('hidden');
                
            } catch (e) {
                console.error('Auth check failed:', e);
                window.location.href = '/login.html?redirect=' + encodeURIComponent(window.location.pathname);
            }
        }
        
        checkAuth();
    </script>
</body>
</html>
